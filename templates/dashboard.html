<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}仪表盘{% endblock %}

{% block content %}
<h2>今日扫描设备</h2>
<table class="table table-bordered table-hover">
  <thead>
    <tr>
      <th>机器名</th>
      <th>员工名</th>
      <th>MAC 地址</th>
      <th>最后扫描时间</th>
      <th>软件清单</th>
    </tr>
  </thead>
  <tbody>
    {% for device in devices %}
    <tr>
      <td>{{ device.hostname }}</td>
      <td>{{ device.username }}</td>
      <!--<td>{{ device.mac_addresses }}</td>-->
      <td>
 	 {% for mac in device.mac_addresses.split(',') %}
    	{{ mac }}<br>
  	{% endfor %}
      </td>
      <td>{{ device.last_scan.strftime('%Y-%m-%d %H:%M:%S') }}</td>
      <td>
        <button class="btn btn-sm btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#softwares{{ loop.index }}">
          展开/收起
        </button>
        <div class="collapse mt-2" id="softwares{{ loop.index }}">
          <ul>
            {% for sw in device.softwares %}
              <li>{{ sw.name }}{% if sw.version %} ({{ sw.version }}){% endif %}</li>
            {% else %}
              <li><em>无软件信息</em></li>
            {% endfor %}
          </ul>
        </div>
      </td>
    </tr>
    {% else %}
    <tr>
      <td colspan="5" class="text-center">暂无今日扫描数据</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<hr />

<h2>违规软件提醒</h2>
{% if violations %}
  <ul class="list-group">
    {% for v in violations %}
      <li class="list-group-item list-group-item-danger">
        用户 <strong>{{ v.username }}</strong> 的设备 <strong>{{ v.hostname }}</strong> (MAC: {{ v.mac }}) 
        安装了违规软件：<strong>{{ v.software }}</strong>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="text-success">无违规软件</p>
{% endif %}

{% endblock %}

